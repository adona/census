<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Joined</title>

  <script src="https://d3js.org/d3.v4.min.js"></script>
  <script src="libs/moment.min.js"></script>

  <link rel="stylesheet" href="timeuse.css">
</head>

<body>
  <!--   Load the data and data dictionary-->
  <script>
    var data, data_dictionary, activities;
    var filepath_dictionary = "https://storage.googleapis.com/iron-flash-216615-dev/atus16_dictionary_compact_2.json",
        filepath_data = "https://gist.githubusercontent.com/adona/14e3d04fa728c551265c87e0d4e985ca/raw/248817c76d1fd77452675be895abda85123b98f9/atus16_subset_1.json";
        // TODO: Currently using only 1/4th of the dataset — switch to using full dataset.
    
    // 1. Load the data dictionary
    d3.json(filepath_dictionary, function(d) {
      data_dictionary = d; // Save data dictionary to global variable
      // Preprocess the activities
      activities = Object.keys(data_dictionary["ACTIVITY2"]).sort();
      activities = activities.filter(x => x != "500000"); // Filter out "Missing data"
      activities = activities.map(function(code) { // Annotate each activity with level and description
        return {
          "level": level(code),
          "code": code,
          "description": data_dictionary["ACTIVITY2"][code],
        };
      });
      
      // 2. Load the data
      d3.json(filepath_data, function(d) {
        // Save the data to global variable
        data = d;
        // Preprocess the data: normalize the weights so that the average weight = 1
        // (NOTE: In which case, the weight of a datapoint ~= the number of persons it represents)
        var avg_w = d3.sum(data.map(x => +x["WT06"]))/data.length;
        for(var i=0; i<data.length; i++)
          data[i]["w_norm"] = data[i]["WT06"]/avg_w;

        // Kickstart the visualizations
        initialize_activities_dropdown();
        initialize_summary_visualization();
        initialize_individuals_visualization();
        
        // Start with the "summary" visualization active - remove the "individuals" visualization
        active_visualization = "summary";
        visualizations["individuals"].remove();
        
        update_selection();
      });
    });    
  </script>
  
  <!--   Create the header with the title & filters -->
  <div id="header">
    <h2> A day in the life of .. </h2>
    <div id="filters"> </div> <br>
    <select id="activities_dropdown"></select>
    <div id="n_persons_div"><text> # persons: </text><text id="n_persons"></text></div>
    <!-- Filters -->
    <script> 
      var filtered_data; 
      function create_filter(filter_id, filter_options, filters_div) {
        // Example use: 
        // create_filter("filter_gender", 
        //       [{"id": "everyone", "label": "Everyone", "condition": p => true},
        //        {"id": "men", "label": "Men", "condition": p => p["SEX"] == "01"},
        //        {"id": "women", "label": "Women", "condition": p => p["SEX"] == "02"}], 
        //       filters_div);
        var new_filter = filters_div.append("form")
          .attr("class", "filter")
          .attr("id", filter_id);

        var filter_buttons = new_filter.selectAll(".filter_button")
          .data(filter_options, option => option["id"])
          .enter()
            .append("div")
              .attr("class", "filter_button");

        filter_buttons.append("input")
          .attr("type", "radio")
          .attr("name", filter_id)
          .attr("id", option => filter_id+"_"+option["id"])
          .on("change", update_selection);

        filter_buttons.append("label")
          .attr("for", option => filter_id+"_"+option["id"])
          .text(option => option["label"]);

        new_filter.select("input").attr("checked", "checked");
      }

      function update_selection() { // The selection has changed
        // Gather all checked buttons
        var checked_inputs = d3.selectAll(".filter_button input:checked"),
            checked_buttons = checked_inputs.select(function() { return this.parentNode; });
        // Extract the associated conditions for filtering
        var conditions = checked_buttons.data().map(option => option["condition"]);
        // Filter the data through each of the conditions
        filtered_data = data; // Start with the full dataset
        for(var i=0; i<conditions.length; i++) {
          filtered_data = filtered_data.filter(conditions[i]);
        }
        
        // Also check the activities drop-down , and filter data by selected activity
        var dropDown = d3.select("#activities_dropdown").node()
        var selected_activity = dropDown.value;
        if(selected_activity != "000000")
          filtered_data = filtered_data.filter(p => p["aggregate_activity_times"][selected_activity] > 0);
        
        // Update the # of results
        d3.select("#n_persons").text(filtered_data.length);
        // Finally, update the visualization!
        update_visualization(filtered_data);
      }
      
      var filters_div = d3.select("#filters");
      create_filter("filter_gender", 
                    [{"id": "everyone", "label": "Everyone", "condition": p => true},
                     {"id": "men", "label": "Men", "condition": p => p["SEX"] == "01"},
                     {"id": "women", "label": "Women", "condition": p => p["SEX"] == "02"}], 
                    filters_div);
      create_filter("filter_age", 
                    [{"id": "everyone", "label": "Everyone", "condition": p => true},
                     {"id": "15_24", "label": "Age 15-24", "condition": p => +p["AGE"] <= 24},
                     {"id": "25-44", "label": "Age 25-64", "condition": p => (+p["AGE"] >= 25 && +p["AGE"] <=64)},
                     {"id": "65_plus", "label": "Age 65+", "condition": p => +p["AGE"] >= 65}], 
                    filters_div);
      create_filter("filter_race", 
                    [{"id": "everyone", "label": "Everyone", "condition": p => true},
                     {"id": "white", "label": "White", "condition": p => p["RACE"] == "0100"},
                     {"id": "black", "label": "Black", "condition": p => p["RACE"] == "0110"},
                     {"id": "other", "label": "Other", "condition": p => ["0100", "0110"].indexOf(p["RACE"]) == -1}],
                    filters_div);
      create_filter("filter_marital", 
                    [{"id": "everyone", "label": "Everyone", "condition": p => true},
                     {"id": "never_married", "label": "Never Married", "condition": p => p["MARST"] == "06"},
                     {"id": "married", "label": "Married", "condition": p => ["01", "02"].indexOf(p["MARST"]) != -1},
                     {"id": "separated", "label": "Separated/Widowed", "condition": p => ["03", "04", "05"].indexOf(p["MARST"]) != -1}],
                    filters_div);
      create_filter("filter_kids", 
                    [{"id": "everyone", "label": "Everyone", "condition": p => true},
                     {"id": "no_children", "label": "No Children", "condition": p => +p["HH_NUMOWNKIDS"] == 0},
                     {"id": "1_plus_children", "label": "1 or More Children", "condition": p => +p["HH_NUMOWNKIDS"] > 0}],
                    filters_div);
      create_filter("filter_edu", 
                    [{"id": "everyone", "label": "Everyone", "condition": p => true},
                     {"id": "highschool", "label": "Highschool or Less", "condition": p => +p["EDUC"] <= 21 },
                     {"id": "college", "label": "Bachelor's Degree", "condition": p => +p["EDUC"] == 40}, 
                     {"id": "masters_doctoral", "label": "Masters or Ph.D.", "condition": p => +p["EDUC"] >= 41}], 
                    filters_div);
      create_filter("filter_employement", 
                    [{"id": "everyone", "label": "Everyone", "condition": p => true},
                     {"id": "employed", "label": "Employed", "condition": p => ["01", "02"].indexOf(p["EMPSTAT"]) != -1},
                     {"id": "unemployed", "label": "Unemployed", "condition": p => ["03", "04"].indexOf(p["EMPSTAT"]) != -1},
                     {"id": "not_looking", "label": "Not Looking", "condition": p => p["EMPSTAT"] == "05"}], 
                    filters_div);
      // create_filter("filter_poverty", 
      //               [{"id": "everyone", "label": "Everyone", "condition": p => true},
      //                {"id": "poverty", "label": "Poverty", "condition": p => +p["pov_percentage_upper"] <= 200},
      //                {"id": "middle_class", "label": "Middle-Class", "condition": p => +p["pov_percentage_lower"] >= 400 && +p["pov_percentage_upper"] < 800}], 
      //               filters_div);
      create_filter("filter_day", 
                    [{"id": "m_f", "label": "Monday-Friday", "condition": p => ["01", "07"].indexOf(p["DAY"]) == -1},
                     {"id": "weekend", "label": "Weekend", "condition": p => ["01", "07"].indexOf(p["DAY"]) != -1}], 
                    filters_div);
    </script>
    <!-- Activity dropdown -->
    <script>
      function initialize_activities_dropdown() {
        // Make a copy of the activities array, and add an "All activities" entry to it.
        var activities_copy = [];
        for(var i=0; i<activities.length; i++)
          activities_copy[i] = activities[i];
        activities_copy.unshift({
          "level": 0,
          "code": "000000",
          "description": "All activities"
        });
        
        var dropDown = d3.select("#activities_dropdown");
        var options = dropDown.selectAll("option")
          .data(activities_copy, a => a["code"]);
        options.enter()
          .append("option")
          .attr("value", a => a["code"])
          .text(a => a["code"] + " - " + a["description"])
        dropDown.on("change", update_selection);
      }
    </script>
    
    <!-- Buttons to toggle between visualizations -->
    <form id="toggle_visualization">
      <div class="choose_visualization_button">
        <input type="radio" name="choose_visualization" id="summary" checked="checked"></input>
        <label for="summary">Summary</label>
      </div>
      <div class="choose_visualization_button">
        <input type="radio" name="choose_visualization" id="individuals"></input>
        <label for="individuals">Individuals</label>
      </div>
    </form>
  </div>
  
  <!--   Create the visualizations -->
  <div id="visualization_container">  
    <!--   Summary visulization -->
    <div class="visualization" id="summary_visualization"></div>
    <script>
      var update_summary;
      function initialize_summary_visualization() {
        var summary_div = d3.select("#summary_visualization");
        
        // Create the axis
        var scaling_factor = 5;
        var percentage_scale = d3.scaleLinear()
          .domain([0,1])
          .range([0, scaling_factor*100]);
        var percentage_axis = d3.axisBottom()
          .scale(percentage_scale)
          .ticks(5, "%");
        summary_div.append("svg")
          .attr("id", "percentage_axis_svg")
          .append("g")
            .attr("class", "x axis")
            .call(percentage_axis);
        
        // Create the bars & labels (for now with width = 0)
        var level_height = ["15px", "12px", "10px"],
            level_margin_top = ["18px", "3px", "1px"],
            level_color = ["#1D3557", "#457B9D", "#A8DADC"];

        var activity_divs = d3.select("#summary_visualization")
          .append("div")
            .attr("id", "activities_div")
          .selectAll(".activity")
          .data(activities, a => a["code"])
          .enter()
            .append("div")
              .attr("class", "activity")

        activity_divs.append("div")
          .attr("class", "activity_bar")
            .style("margin-top", a => level_margin_top[a["level"]-1])
            .style("height", a => level_height[a["level"]-1])
            .style("background-color", a => level_color[a["level"]-1]);

        activity_divs.append('div')
          .attr("class", "activity_bar_label")
          .style("line-height", a => level_height[a["level"]-1])
          .style("font-size", a => level_height[a["level"]-1]);

        // The update function
        update_summary = function(filtered_data) {
          // 1. Update the stats
          for(var i=0; i<activities.length; i++)
            activities[i]["stats"] = get_activity_stats(filtered_data, activities[i]["code"]);
          // Update the width of the bars based on the new stats
          d3.selectAll(".activity_bar")
            .style("width", a => (scaling_factor*a["stats"]["perc_persons_did_activity"]) + "px");
          d3.selectAll(".activity_bar_label")
            .text(a => "(" + d3.format(".0f")(a["stats"]["perc_persons_did_activity"]) + "%) " + a["description"])
        }
        
        function get_activity_stats(data, code) {
          var n_persons_total = weighted_length(data.map(p => p["w_norm"])),
              datapoints_did_activity = data.filter(p => +p["aggregate_activity_times"][code]>0),
              n_datapoints_did_activity = datapoints_did_activity.length,
              n_persons_did_activity = weighted_length(datapoints_did_activity.map(p => p["w_norm"])),
              perc_persons_did_activity = n_persons_did_activity / n_persons_total * 100,
              total_time_did_activity = weighted_sum(datapoints_did_activity.map(p => p["aggregate_activity_times"][code]), 
                                                     datapoints_did_activity.map(p => p["w_norm"])),
              avg_time_persons_did_activity =  total_time_did_activity / n_persons_did_activity,
              avg_time_all_persons = total_time_did_activity / n_persons_total;
          return {
            "n_datapoints_did_activity": n_datapoints_did_activity,
            "perc_persons_did_activity": perc_persons_did_activity,
            "avg_time_persons_did_activity": avg_time_persons_did_activity,
            "avg_time_all_persons": avg_time_all_persons
          };
        }
      }
  </script>
  
    <!--  Individuals visualization -->
    <div class="visualization" id="individuals_visualization">
      <!--   timeline visualization template -->
      <div class="timeline_div">
        <div class="infobox">
          <text class="description">Who: </text>
          <text class="value age"></text><span>yo  </span>
          <text class="value sex"></text><span>, </span>
          <text class="value race"></text><span>, </span>
          <text class="value marital"></text> </br>

          <text class="description">Household: </text>
          <text class="value adults"></text><span> adults, </span>
          <text class="value children"></text><span> children </span></br>

          <text class="description">Household income: </text><span> %</span>
          <text class="value income"></text><span> of poverty line </span></br>

          <text class="description">Work: </text>
          <text class="value status"></text><span> - </span>
          <text class="value occupation"></text> </br>

          <text class="description">Day: </text>
          <text class="value day"></text> </br>
        </div>
        <div class="serialno">
          <text class="description">Person #: </text>
          <text class="value"></text>
        </div>
        <svg class="timeline_svg"></svg>
      </div>
    </div>
    <script>
      // Extract timeline visualization template for later use.
      var timeline_div_template = d3.select(".timeline_div").remove().node();

      var update_individuals;
      function initialize_individuals_visualization() {
        // Add the "show more" button
        d3.select("#individuals_visualization")
          .append("div").attr("id", "show_more")
          .append("span").text("Show more");

        
        update_individuals = function(filtered_data) {
          // Remove all the current timelines
          d3.selectAll(".timeline_div").remove();
          
          // Render page_size new timelines
          var page_size = 50, current_page = 1;
          for (var i = 0; i < Math.min(page_size, filtered_data.length); i++)
            visualize_individual(filtered_data[i]);
          
          // Update the "Show more" button on-click function to tie it to current data
          d3.select("#show_more").on("click", function() {
            // Add page_size more timelines
            for (var i = page_size*current_page; i < Math.min(page_size*(current_page+1), filtered_data.length); i++)
              visualize_individual(filtered_data[i]);
            // Increment the page counter
            current_page += 1;
          });
        }
        
        function visualize_individual(person) {
          var timeline = person["activities"];
          
          // Instantiate the template for visualizing an individual person
          var timeline_div = timeline_div_template.cloneNode(true), // clone the template
              timeline_div_id = "p_" + person["SERIAL"];
          timeline_div.setAttribute("id", timeline_div_id); // give the clone an unique ID
          var container = d3.select("#individuals_visualization").node(), 
              show_more = d3.select("#show_more").node();
          container.insertBefore(timeline_div, show_more); // insert it in the DOM
          timeline_div = d3.select("#" + timeline_div_id); // re-select it as a D3 selection

          // Populate the infobox
          var infobox = timeline_div.select(".infobox");
          infobox.select(".sex")
            .text(get_description("SEX", person["SEX"]));
          infobox.select(".race")
            .text(get_description("RACE", person["RACE"]));
          infobox.select(".age")
            .text(+person["AGE"]);
          infobox.select(".marital")
            .text(get_description("MARST", person["MARST"]));
          infobox.select(".adults")
            .text(+person["HH_NUMADULTS"]);
          infobox.select(".children")
            .text(+person["HH_NUMKIDS"]);
          infobox.select(".income")
            .text(Math.round(+person["pov_percentage_upper"]));
          infobox.select(".status")
            .text(get_description("EMPSTAT", person["EMPSTAT"]));
          infobox.select(".occupation")
            .text(get_description("OCC", person["OCC"].substring(1)));
          infobox.select(".day")
            .text(get_description("DAY", person["DAY"]));
          var serialno_box = timeline_div.select(".serialno .value")
            .text(+person["SERIAL"])

          // Create the actual timeline
          var svg = timeline_div.select("svg"),
            bbox = svg.node().getBoundingClientRect(),
            width = bbox["width"],
            height = bbox["height"],
            margin = 20,
            margin_right = 150;
          
          // Create the axis
          // Timelines run from 4am to 4am next day.
          var time_extent = d3.extent([parse_time("04:00:00"),
                                       parse_time("03:59:59").add(1, "days")]);
          var time_scale = d3.scaleTime()
            .domain(time_extent)
            .range([margin, width - margin_right]);
          var time_axis = d3.axisBottom()
            .scale(time_scale)
            .tickFormat(d3.timeFormat("%I %p"));
          var y0 = height - margin;
          svg.append("g")
            .attr("class", "x axis")
            .attr("transform", "translate(0," + y0 + ")")
            .call(time_axis);

          // Create the activity arcs
          timeline = preprocess_timeline(timeline, time_scale);
          var arcs = svg.selectAll(".arc")
            .data(timeline, activity => person["SERIAL"] + "_" + activity["ACTLINE"]);
          arcs.enter()
            .append('path')
            .attr("class", "arc")
            .attr("d", activity =>
              d3.arc()
              .innerRadius(0)
              .outerRadius(activity["x_radius"])
              .startAngle(-Math.PI / 2)
              .endAngle(Math.PI / 2)())
            .attr("fill", get_arc_color)
            .attr("transform", activity =>
              "translate(" + activity["x_center"] + "," + y0 + ")")
            .on("mouseover", arcMouseOver)
            .on("mouseout", arcMouseOut);

          // Add activity description on mouse-over an activity arc
          function arcMouseOver(activity, i) { // Add arc label
            var arc_description = "(" + activity["START"].substring(0, 5) + "-" +
                  activity["STOP"].substring(0, 5) + ") " +
                  get_description("ACTIVITY2", activity["ACTIVITY2"]);
            svg.append("text")
              .attr("id", "label_" + person["SERIAL"] + "_" + activity["ACTLINE"])
              .attr("class", "activity_label")
              .attr("x", activity["x_center"] + 5)
              .attr("y", y0 - activity["x_radius"] - 5)
              .text(arc_description);
          }
          
          function arcMouseOut(activity, i) { // Remove arc label
            d3.select("#label_" + person["SERIAL"] + "_" + activity["ACTLINE"]).remove();
          }
        }
        
        function preprocess_timeline(timeline, time_scale) {
          if ("preprocessed" in timeline)
            return timeline; // already pre-processed (have visualized this hh before)

          // Filter "Unable to code" activities
          timeline = timeline.filter(activity => activity["ACTIVITY2"].substring(0, 2) != "50");
          
          // Truncate the last activity so that the total time is 24h 
          // (the first activity always starts at 4am)
          timeline[timeline.length - 1]["STOP"] = "03:59:59"
          
          // Parse the START & STOP times, and pre-compute SVG coodinates
          var next_day = false;
          for (var i = 0; i < timeline.length; i++) {
            var activity = timeline[i];
            var start = parse_time(activity["START"]), // Parse from string
                stop = parse_time(activity["STOP"]);
            if (start > stop) { // Detect that we've just crossed midnight..
              next_day = true;
              stop.add(1, "days");
            } else if (next_day) { // .. and from then onward add a day to all times.
              start.add(1, "days");
              stop.add(1, "days");
            }

            // Pre-compute svg coordinates
            activity["x_start"] = time_scale(start);
            activity["x_stop"] = time_scale(stop);
            activity["x_center"] = (activity["x_start"] + activity["x_stop"]) / 2;
            activity["x_radius"] = (activity["x_stop"] - activity["x_start"]) / 2;
          }
          timeline["preprocessed"] = true;
          return timeline;
        }
        
        function get_arc_color(activity) {
          var category = activity["ACTIVITY2"].substring(0, 2);
          var arc_colors = { // See most colors here: https://coolors.co/0d2c54-69306d-247ba0-70c1b3-ffb400
            "01": "#EFEFEF", // Sleeping & personal care — Grey
            "04": "#0D2C54", // Work — Dark Blue
            "05": "#69306D", // Education — Purple
            "06": "#247BA0", // Errands & Chores — Light Blue
            "07": "#70C1B3", // Caring for others — Green
            "02": "#F77046", // Eating & drinking — Orange
            "08": "#FFB400", // Leisure — Bright Yellow
            "03": "#999999", // Traveling — Medium-grey
          };
          return arc_colors[category];
        }        
      }
    </script>
  
    <!--  Toggle between the two  -->
    <script>
      var visualization_container = d3.select("#visualization_container").node(),
          visualizations = 
            {"summary": d3.select("#summary_visualization").node(),
             "individuals": d3.select("#individuals_visualization").node()},
          active_visualization;
      
      function update_visualization(filtered_data) {
        if (active_visualization == "summary") update_summary(filtered_data);
        else update_individuals(filtered_data);
      }

      // Add on change event handler to switch between the visualizations
      d3.selectAll("#toggle_visualization input").on("change", function() {
        if(this.id != active_visualization) {
          d3.select(".visualization").remove(); // Swap out the current visualization
          visualization_container.appendChild(visualizations[this.id]); // Swap in the new one
          active_visualization = this.id; // Update the active visualization
          update_selection();  // Refresh the visualization in case the selection has changed since last time I saw it
        }
      });
</script>
  
    <!-- Helper functions   -->
    <script>
      function level(code) {
          // Start at the highest level and keep decreasing as long as the corresponding portion of the code is "00"
          var level = 3; 
          while(level>0 && code.substring((level-1)*2, level*2) == "00")
            level = level-1;
          return level;
      }

      function weighted_sum(data, weights) {
        var ws = 0;
        for(var i=0; i<data.length; i++)
          ws += (+data[i]) * (+weights[i]);
        return ws;
      }

      function weighted_length(weights) {
        var wl = 0; 
        for(var i=0; i<weights.length; i++)
          wl += (+weights[i]);
        return wl;
      }
      
      function parse_time(time_str) {
        return moment(time_str, "hh:mm:ss");
      }
      
      function get_description(field, value) {
        return data_dictionary[field][value];
      }
    </script>
  </div>
</body>
</html>